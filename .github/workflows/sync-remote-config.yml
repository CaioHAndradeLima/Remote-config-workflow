name: sync-remote-config

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:

jobs:
  sync-remote-config:
    runs-on: ubuntu-latest

    env:
      FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
      FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
      #SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4

      # Step 1: Request token from Firebase
      # Step 1: Request token from Firebase
      - name: ðŸ” Requesting Firebase token
        id: get_token
        run: |
          echo "ðŸ“¥ Requesting Firebase token..."

          PRIVATE_KEY_CLEAN=$(echo "${FIREBASE_PRIVATE_KEY}" | sed 's/\\n/\n/g')

          RESPONSE=$(.github/action/generate-firebase-token.sh "${FIREBASE_CLIENT_EMAIL}" "$PRIVATE_KEY_CLEAN")

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token // empty')

          if [[ -z "$ACCESS_TOKEN" ]]; then
            echo "âŒ Failed to retrieve access_token from Firebase. Stopping workflow."
            echo "::set-output name=error::true"
            echo "::set-output name=message::Failed to retrieve access_token from Firebase."
            exit 1
          fi

          echo "âœ… Firebase token acquired."
          echo "token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

      # Step 2: GET current remote config template
      - name: ðŸ“¡ Step 2 - Request remote config template
        id: get_remote_config
        run: |
          echo "ðŸ“¥ Requesting Remote Config template..."
          chmod +x .github/action/firebase-get-request.sh
          
          PROJECT_ID="${FIREBASE_PROJECT_ID}"
          ACCESS_TOKEN="${{ steps.get_token.outputs.token }}"
          OUT_FILE=".remote_config.json"
          
          .github/action/firebase-get-request.sh "$PROJECT_ID" "$ACCESS_TOKEN" "$OUT_FILE"
          
          echo "âœ… Remote config saved to $OUT_FILE"

      # Step 3: Validate keys using snake_case checker
      - name: ðŸ Step 3 - Check firebase name
        id: check_snake_case
        run: |
          echo "ðŸ” Extracting information list from firebase"
          
          chmod +x .github/action/check-snake-case.sh
          source .github/action/check-snake-case.sh
          
          # Extract the string field JSON stored in firebase.defaultValue.value
          raw_json=$(jq -r '.parameters.firebase.defaultValue.value' .remote_config.json)
          
          # Unescape and parse string JSON using jq safely
          info_list=$(echo "$raw_json" | jq -R 'fromjson | .firebase')
          
          echo "ðŸ“‹ List to check: $info_list"
          
          # Call your snake_case validation function
          if is_list_snake_case "$info_list"; then
            echo "âœ… All items in 'firebase' are in snake_case."
            echo "has_violation=false" >> $GITHUB_OUTPUT
          else
            echo "âŒ Found item(s) not in snake_case."
            echo "has_violation=true" >> $GITHUB_OUTPUT
          fi

      # Step 4: Notify Slack if any problem occurs or if snake_case mismatch found
      - name: ðŸ“¢ Step 4 - Notify Slack
        if: ${{ always() }}
        run: |
          # TODO: If we had issues in any step or found snake_case violations,
          # format a message and send it to Slack using webhook
